<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö–∞—Ä—Ç–∞ –ø–ª–æ—â–∞–¥–æ–∫</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>
    <div class="top-bar">
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.first_name or "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" }}</h2>
        <div class="profile-container" onclick="toggleProfilePopup()">
            <span class="profile-name">{{ user.first_name }} {{ user.last_name }}</span>
            <div class="profile-popup" id="profile-popup">
                <a href="/my-bookings">üìã –ú–æ–∏ –∑–∞–ø–∏—Å–∏</a>
                <a href="/teams">üë• –û—Ç–∫—Ä—ã—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã</a>
                <a href="/my-teams">‚öΩ –ú–æ–∏ –∫–æ–º–∞–Ω–¥—ã</a>
                <a href="/support">üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
                {% if is_admin %}
                  <hr style="border:none;border-top:1px solid #eee;margin:6px 0;">
                  <a href="/admin/users">üîß –ê–¥–º–∏–Ω ¬∑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                  <a href="/admin/bookings">üîß –ê–¥–º–∏–Ω ¬∑ –ó–∞–ø–∏—Å–∏</a>
                  <a href="/admin/feedback">üîß –ê–¥–º–∏–Ω ¬∑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</a>
                {% endif %}
                <a href="/logout">üö™ –í—ã–π—Ç–∏</a>
            </div>
        </div>
    </div>

    <div id="map" style="height: 80vh;"></div>

    <script>
        const map = L.map('map').setView([55.9167, 37.8167], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap',
        }).addTo(map);

        const grounds = {{ grounds | tojson }};

        grounds.forEach(place => {
            if (place.latitude && place.longitude) {
                L.marker([place.latitude, place.longitude])
                    .addTo(map)
                    .bindPopup(`
                        <b>${place.school_name}</b><br>
                        ${place.address}<br>
                        <i>${place.sport_types || ''}</i><br>
                        <a href="/book/${place.id}">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</a>
                    `);
            }
        });

        function toggleProfilePopup() {
            const popup = document.getElementById("profile-popup");
            popup.style.display = popup.style.display === "block" ? "none" : "block";
        }

        window.addEventListener("click", function (e) {
            if (!e.target.closest(".profile-container")) {
                const popup = document.getElementById("profile-popup");
                if (popup) popup.style.display = "none";
            }
        });
    </script>
</body>
</html>
