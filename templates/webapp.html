<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SportCity — Mini App</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="top-bar"><h2>Открываем мини-приложение…</h2></div>

  <div class="wrap">
    <div class="card">
      <p class="muted">Если вы видите это в обычном браузере, откройте страницу из чата бота Telegram.</p>
      <div id="msg" class="muted">Пробуем авторизоваться…</div>
      <div id="ok" class="ok" style="display:none">Авторизация прошла, загружаем карту…</div>
      <div id="err" class="err" style="display:none"></div>

      <div id="fallback" style="display:none;margin-top:12px">
        <p class="muted">Не открывается как WebApp? Попробуйте запустить мини-приложение напрямую:</p>
        <p><a href="tg://resolve?domain=SportCityKorolevBot&startapp=1">Открыть в Telegram (приложение)</a></p>
        <p><a href="https://t.me/SportCityKorolevBot?startapp=1" target="_blank" rel="noopener">Открыть через t.me (из браузера)</a></p>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;

    function show(id, text){
      const el = document.getElementById(id);
      if (text) el.textContent = text;
      el.style.display = 'block';
    }

    if (!tg) {
      show('err', 'Это не Telegram WebApp. Откройте из чата бота или воспользуйтесь ссылками ниже.');
      show('fallback');
    } else {
      tg.ready(); tg.expand();
      const initData = tg.initData;
      if (!initData) {
        show('err', 'initData пустой. Запустите мини-приложение из бота или используйте ссылки ниже.');
        show('fallback');
      } else {
        const form = new FormData();
        form.append('init_data', initData);

        fetch('/tg_webapp_auth', { method: 'POST', body: form, credentials: 'include' })
          .then(r => { if (!r.ok) throw new Error('Auth failed: ' + r.status); return r.json(); })
          .then(() => { show('ok'); location.href = '/main'; })
          .catch(e => { show('err', e.message); show('fallback'); });
      }
    }
  </script>
</body>
</html>
