<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Вход в мини-приложение</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    .card{max-width:880px;margin:60px auto;padding:30px;border-radius:16px;background:#fff;box-shadow:0 6px 40px rgba(0,0,0,.08)}
    .btn{padding:10px 18px;border-radius:10px;border:0;background:#1a73e8;color:#fff;font-weight:600;cursor:pointer}
  </style>
</head>
<body>
  <div class="card">
    <h2>Вход в мини-приложение</h2>
    <p>Telegram передаст нам ваши публичные данные профиля (имя/username/id).
       Дополнительных разрешений в WebApp нет — подпись проверяется на сервере.</p>
    <p id="who"></p>
    <button id="go" class="btn">Войти</button>
    <p id="msg" style="color:#c00;margin-top:12px"></p>
  </div>

<script>
  const go = document.getElementById('go');
  const msg = document.getElementById('msg');
  const who = document.getElementById('who');

  try {
    Telegram.WebApp.ready();
    const initData = Telegram.WebApp.initData || '';
    const initDataUnsafe = Telegram.WebApp.initDataUnsafe || {};
    if (initDataUnsafe.user) {
      who.textContent = 'Войдёте как: ' + (initDataUnsafe.user.first_name || '') +
                        (initDataUnsafe.user.last_name ? (' ' + initDataUnsafe.user.last_name) : '');
    }
    go.onclick = async () => {
      msg.textContent = '';
      const fd = new FormData();
      fd.append('init_data', initData);
      const r = await fetch('/tg_webapp_auth', {method:'POST', body:fd});
      if (r.ok) { window.location.href = '/main'; }
      else { msg.textContent = 'Auth failed: ' + (await r.text()); }
    };
  } catch (e) {
    msg.textContent = 'WebApp init error: ' + e;
  }
</script>
</body>
</html>
